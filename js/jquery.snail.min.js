$.support.cors=true;$.mobile.phone=navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry)/);var optionArray=["승강기","촉지도","주차장","경사로","화장실"];var qmap={data:null,sess:null,options:{db:"maps",skip:0,limit:30,sort:"title",query:{lat:"lat:[0 TO 360]"},success:function(e){this.data=e},error:function(e,t){alert("[Error] : Fail to data retrive")}},plugin:function(e,t){$[e]=$[e]||{};$[e]=function(e,t){if(arguments.length)this.__init(e,t)};$.extend($[e].prototype,this,t);$.fn[e]=function(t){var n=typeof t==="string",r=Array.prototype.slice.call(arguments,1),i=this;this.each(function(){var s=$.data(this,e);if(!s)s=$.data(this,e,new $[e](t,this));if(n)i=s[t].apply(s,r)});return i}},db:function(e){return $.couch.db(e||this.options.db)},getPath:function(e){switch(e){case"image":return $.couch.urlPrefix+"/_image/"+this.options.db;default:return $.couch.urlPrefix+"/"+this.options.db}},shift:function(e){var t=e+this.options.skip||0;if(e>0&&t<this.options.total_rows||0){return this.options.skip=t}else if(e<0&&t>=0){return this.options.skip=t}return-1},getNext:function(e,t){if(this.shift(this.options.limit)!==-1){this.getView(e,t)}},getPrev:function(e,t){if(this.shift(-this.options.limit)!==-1){this.getView(e,t)}},getDoc:function(e,t){this.db().openDoc(e,t)},setDoc:function(e,t){this.db().saveDoc(e,t)},dropDoc:function(e,t){this.db().removeDoc(e,t)},getScore:function(e){var t=0;for(i=0;i<e.length;i++){t+=Number(e[i])}return t},parseKeyword:function(e){var t=e.charAt(0);searchWord={};switch(t){case"@":if(e.substr(1))searchWord={search:'username:"'+e.substr(1)+'"'};break;case"#":if(e.substr(1))searchWord={search:'tags:"'+e.substr(1)+'"'};break;default:if(e)searchWord={search:'title:"'+e+'"'}}return searchWord},viewMap:function(){var e=localStorage.getItem("map.type")=="gmap"?"index.html":"index.htm";document.location=e},chkLogin:function(e,t){$.couch.session({success:e,error:t})},userLogin:function(e){e=e||document.location.href.split("/").pop();document.location="login.htm?url="+e},userLogout:function(){var e=this;try{$.couch.logout({success:function(t){alert("로그아웃 되었습니다.");e.viewMap()},error:function(e,t,n){alert("로그아웃 오류:"+e+t+n)}})}catch(t){alert(t)}},getGeoLocation:function(e,t){navigator.geolocation.getCurrentPosition(e,t)},getGeoInformation:function(e,t){navigator.geolocation.getCurrentPosition(function(n){var r={};var i=new google.maps.LatLng(n.coords.latitude,n.coords.longitude);r.distance=Math.round(google.maps.geometry.spherical.computeDistanceBetween(i,e));r.heading=Math.round(google.maps.geometry.spherical.computeHeading(i,e));if(r.distance>1e3){r.distance=r.distance/1e3+"Km"}else{r.distance=r.distance+"m"}t(r)})},geoToAddress:function(e,t){var n=new google.maps.Geocoder;n.geocode({latLng:e},t)},chkNetwork:function(){if(navigator.connection&&navigator.connection.type==Connection.NONE){navigator.notification.confirm("네트워크 오류\n\n프로그램을 종료하시겠습니까?",function(e){if(e==1)navigator.app.exitApp()})}},getView:function(e,t){var n=$.extend(this.options.query,t.query),r=[];for(k in n)r.push(n[k]);delete t.query;var i={include_docs:true,sort:this.options.sort,skip:this.options.skip,limit:this.options.limit,error:this.options.error,success:this.options.success};$.extend(true,i,t,{q:r.join(" AND "),cache:Math.floor((new Date).getTime()/1e3)});this.db().find("marker"+e,i)}};(function(e){var t,n,r,i,s,o,u;qmap.plugin("gmap",{__init:function(r,i){t=this;e.extend(this.options,r||{},{success:t.success});google.maps.visualRefresh=true;n=new google.maps.Map(i,{zoom:17,minZoom:8,maxZoom:19,panControl:false,mapTypeControl:false,mapTypeId:google.maps.MapTypeId.ROADMAP,center:new google.maps.LatLng(37.57,126.97)});if(this.options.db=="maps"){google.maps.event.addListener(n,"bounds_changed",function(){s=this.getBounds()});google.maps.event.addListenerOnce(n,"bounds_changed",function(){s=this.getBounds();e.mobile.loading("show");t.getView("/index",r)})}else{google.maps.event.addListener(n,"bounds_changed",function(){clearTimeout(u);u=setTimeout(function(){var n=this.getZoom();var i=this.getBounds().getNorthEast();var s=this.getBounds().getSouthWest();e.extend(r,{query:{zoom:"zoom<int>:["+n+" TO 19]",lat:"lat<double>:["+s.lat()+" TO "+i.lat()+"]",lng:"lng<double>:["+s.lng()+" TO "+i.lng()+"]"}});e.mobile.loading("show");t.clearMarkers();t.getView("/index",r)},100)})}navigator.geolocation.getCurrentPosition(function(e){var t=new google.maps.LatLng(e.coords.latitude,e.coords.longitude);var r=new google.maps.Marker({map:n,position:t,draggable:true});google.maps.event.addListener(r,"dragend",function(){document.location="form.htm?lat="+r.getPosition().lat()+"&lng="+r.getPosition().lng()});google.maps.event.addListener(r,"click",function(){document.location="form.htm?lat="+r.getPosition().lat()+"&lng="+r.getPosition().lng()});n.panTo(t)})},success:function(t){e.mobile.loading("hide");qmap.options.total_rows=t.total_rows;if(t.rows.length>0){r=[];e.each(t.rows,function(t,i){var u=i.value||i.doc;var a="";var f=qmap.getScore(u.option||[]);var l=new google.maps.LatLng(u.position[0],u.position[1]);var c="img/marker"+(3-Math.ceil(f/2)||3)+".png";for(file in u.attachments){a='<img src="'+qmap.getPath("image")+"/"+u._id+"/"+file+"?resize=90x90"+'" alt="'+file.alt+'" class="marker-thumb">';break}var h=new google.maps.Marker({position:l,title:u.title,icon:c});google.maps.event.addListener(h,"click",function(){if(o){o.close()}var t='<h3 style="margin:5px 0"><a href="view.htm?id='+u._id+'" rel="external" class="info-link">'+u.title+'&nbsp;<span class="ui-icon ui-icon-arrow-r ui-icon-shadow" style="display:inline-block">&nbsp;</span></a></h3>';t+='<hr size="1"><div style="margin:-5px 0 3px 0;">'+u.address.replace("대한민국 ","")+"</div>";t+='<div style="float:left">';var r="",i="";if(u.tags){e(u.tags.split(",")).each(function(){r+='<span class="tag" title="태그:'+this+'">'+this+"</span>"});t+=r}if(u.options){e(u.options).each(function(e){if(this=="1")i+='<img src="img/a-icon'+(e+1)+'.png" class="picto" alt="'+optionArray[e]+'">&nbsp;'});t+='<div style="clear:both;padding:3px;">'+i+"</div>"}t+="</div>";t+='<div style="float:right">'+a+"</div>";t='<div style="min-width:220px;overflow:auto;">'+t+"</div>";o=new google.maps.InfoWindow({content:t});o.open(n,h)});r.push(h);s.extend(l)});i=new MarkerClusterer(n,r,{gridSize:30,maxZoom:14})}},clearMarkers:function(){if(i){i.clearMarkers()}},findPlace:function(e,t){this.clearMarkers();this.getView("/index",{query:this.parseKeyword(e),sort:t||"title"})}})})(jQuery);(function(e){var t,n;qmap.plugin("able",{__init:function(r,i){t=i;n=this;console.log(r);e.extend(this.options,r||{},{success:n.success});e.mobile.loading("show");this.getView("/index",r)},success:function(r){e.mobile.loading("hide");n.options.total_rows=r.total_rows;if(r.rows.length>0){if(!e(t).html())e(t).append('<ul class="ui-listview">');var i=e(t).children("ul.ui-listview");e.each(r.rows,function(t,n){var r=n.value||n.doc;var s=qmap.getScore(r.options||[]);var o='<img src="img/blank.png" width=85 height=85 style="filter:alpha(opacity=10);opacity:0.1;-moz-opacity:0.1;filter:grapscale(100);-webkit-filter:grayscale(100%); ">';for(file in r.attachments||{}){o='<img src="'+qmap.getPath("image")+"/"+r._id+"/"+file+"?resize=95x95"+'" width="85" height="85" alt="'+(file.alt||"")+'">';break}var u="",a="";if(r.tags){e(r.tags.split(",")).each(function(){u+='<span class="tag" title="태그:'+this+'">'+this+"</span>"})}if(r.options){e(r.options).each(function(e){if(this=="1")a+='<img src="img/a-icon'+(e+1)+'.png" class="picto">'})}i.append('<li><a href="view.htm?id='+r._id+'" title="'+r.title+'" rel="external">'+o+"<h3>"+(r.title||"[위치명 없음]")+"</h3><p>"+r.address.replace("대한민국 ","")+"<br/>"+a+'</p><p class="ui-li-aside">'+u+"</p></a></li>")})}if((r.offset||r.skip)+n.options.limit>=r.total_rows){e("#next-btn").remove()}else{if(e("#next-btn").length==0){e("#page-able").append('<a href="javascript:moreAble();" class="ui-btn" id="next-btn" title="더 보기">더보기..</a>')}}e("ul.ui-listview").listview().listview("refresh")},clearMarkers:function(){e("#next-btn").remove();e(".ui-content .ui-listview").remove()},findPlace:function(e,t){this.clearMarkers();this.getView("/index",{skip:0,query:this.parseKeyword(e),sort:t||"title"})},morePlace:function(e,t){if(e){this.getNext("/index",{query:this.parseKeyword(e),sort:t||"title"})}else{this.getNext("/index",{limit:this.options.limit,sort:t||"title"})}}})})(jQuery);$.p=function(e){var t=decodeURI((RegExp(e+"="+"(.+?)(&|$)").exec($.mobile.document[0].location.search)||[,null])[1]);return t=="null"?null:t}